document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const closedCard = document.getElementById('closedCard');
    const openedCard = document.getElementById('openedCard');
    const rsvpBtn = document.getElementById('rsvpBtn');
    const cancelRsvp = document.getElementById('cancelRsvp');
    const rsvpContainer = document.getElementById('rsvpContainer');
    const rsvpForm = document.getElementById('rsvpForm');
    const successMessage = document.getElementById('successMessage');
    const viewMapBtn = document.getElementById('viewMapBtn');
    const mapBtn = document.getElementById('mapBtn');
    const mapModal = document.getElementById('mapModal');
    const closeMapBtn = document.getElementById('closeMapBtn');
    const closeCardBtn = document.getElementById('closeCardBtn');
    const musicToggle = document.getElementById('musicToggle');
    const backgroundMusic = document.getElementById('backgroundMusic');
    const guestCount = document.getElementById('guestCount');
    const minusBtn = document.getElementById('minusBtn');
    const plusBtn = document.getElementById('plusBtn');
    const guestCountSection = document.getElementById('guestCountSection');
    const guestNameInput = document.getElementById('guestNameInput');
    const displayGuestName = document.getElementById('displayGuestName');
    
    // Get guest name from URL
    const urlParams = new URLSearchParams(window.location.search);
    let guestName = urlParams.get('name');
    
    // Decode and set guest name
    if (guestName) {
        guestName = decodeURIComponent(guestName.replace(/\+/g, ' '));
        displayGuestName.textContent = guestName;
        guestNameInput.value = guestName;
        
        // Add welcome effect for personalized names
        setTimeout(() => {
            displayGuestName.style.transform = 'scale(1.05)';
            displayGuestName.style.transition = 'transform 0.3s ease';
            setTimeout(() => {
                displayGuestName.style.transform = 'scale(1)';
            }, 300);
        }, 1000);
    }
    
    // Open card animation
    closedCard.addEventListener('click', function() {
        // Add opening animation class
        closedCard.style.transform = 'rotateY(-180deg)';
        closedCard.style.opacity = '0';
        closedCard.style.pointerEvents = 'none';
        
        // Show opened card after delay
        setTimeout(() => {
            closedCard.style.display = 'none';
            openedCard.style.display = 'block';
            
            // Animate pages appearance
            const pages = document.querySelectorAll('.card-page');
            pages.forEach((page, index) => {
                page.style.opacity = '0';
                page.style.transform = 'translateX(' + (index === 0 ? '-20px' : '20px') + ')';
                
                setTimeout(() => {
                    page.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                    page.style.opacity = '1';
                    page.style.transform = 'translateX(0)';
                }, index * 200);
            });
        }, 600);
    });
    
    // Close card animation
    closeCardBtn.addEventListener('click', function() {
        // Animate pages out
        const pages = document.querySelectorAll('.card-page');
        pages.forEach((page, index) => {
            page.style.opacity = '0';
            page.style.transform = 'translateX(' + (index === 0 ? '-20px' : '20px') + ')';
        });
        
        // Hide opened card
        setTimeout(() => {
            openedCard.style.display = 'none';
            closedCard.style.display = 'block';
            
            // Reset closed card
            setTimeout(() => {
                closedCard.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                closedCard.style.transform = 'rotateY(0deg)';
                closedCard.style.opacity = '1';
                closedCard.style.pointerEvents = 'auto';
            }, 50);
        }, 400);
    });
    
    // Open RSVP form
    rsvpBtn.addEventListener('click', function() {
        rsvpContainer.style.display = 'block';
        rsvpForm.style.display = 'block';
        successMessage.style.display = 'none';
        
        // Smooth scroll to form
        setTimeout(() => {
            rsvpContainer.scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
        }, 100);
    });
    
    // Close RSVP form
    cancelRsvp.addEventListener('click', function() {
        rsvpContainer.style.display = 'none';
        rsvpForm.reset();
        
        // Reset guest count section
        guestCountSection.style.display = 'block';
        const yesRadio = document.querySelector('input[value="yes"]');
        if (yesRadio) yesRadio.checked = true;
    });
    
    // Handle attendance selection
    const attendanceRadios = document.querySelectorAll('input[name="attendance"]');
    attendanceRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'yes') {
                guestCountSection.style.display = 'block';
                guestCountSection.style.animation = 'fadeIn 0.3s ease';
            } else {
                guestCountSection.style.display = 'none';
            }
        });
    });
    
    // Handle guest count buttons
    minusBtn.addEventListener('click', function() {
        let currentValue = parseInt(guestCount.value);
        if (currentValue > 1) {
            guestCount.value = currentValue - 1;
            animateCountChange();
        }
    });
    
    plusBtn.addEventListener('click', function() {
        let currentValue = parseInt(guestCount.value);
        if (currentValue < 10) {
            guestCount.value = currentValue + 1;
            animateCountChange();
        }
    });
    
    function animateCountChange() {
        guestCount.style.transform = 'scale(1.1)';
        setTimeout(() => {
            guestCount.style.transform = 'scale(1)';
        }, 150);
    }
    
    // Handle form submission
    rsvpForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(this);
        const data = {
            guest_name: formData.get('guest_name'),
            attendance: formData.get('attendance'),
            guest_count: formData.get('guest_count'),
            message: formData.get('message'),
            timestamp: new Date().toISOString(),
            url: window.location.href
        };
        
        // Show loading
        showLoading();
        
        // Simulate API call with realistic delay
        setTimeout(() => {
            // Save to Google Sheets (implement this function)
            saveToGoogleSheets(data);
            
            // Hide loading
            hideLoading();
            
            // Show success message with animation
            rsvpForm.style.display = 'none';
            successMessage.style.display = 'block';
            successMessage.style.animation = 'fadeIn 0.5s ease';
            
            // Add confetti effect
            createConfetti();
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                rsvpContainer.style.display = 'none';
                rsvpForm.reset();
                rsvpForm.style.display = 'block';
                successMessage.style.display = 'none';
                guestCountSection.style.display = 'block';
            }, 5000);
        }, 2000);
    });
    
    // Open map modal
    function openMapModal() {
        mapModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Add opening animation
        mapModal.style.animation = 'fadeIn 0.3s ease';
    }
    
    viewMapBtn.addEventListener('click', openMapModal);
    mapBtn.addEventListener('click', openMapModal);
    
    // Close map modal
    function closeMapModal() {
        mapModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    closeMapBtn.addEventListener('click', closeMapModal);
    
    // Close modal when clicking outside
    mapModal.addEventListener('click', function(e) {
        if (e.target === mapModal) {
            closeMapModal();
        }
    });
    
    // Close with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && mapModal.style.display === 'flex') {
            closeMapModal();
        }
    });
    
    // Music toggle
    let musicPlaying = false;
    let userInteracted = false;
    
    musicToggle.addEventListener('click', function() {
        userInteracted = true;
        
        if (musicPlaying) {
            backgroundMusic.pause();
            musicToggle.innerHTML = '<i class="fas fa-music"></i><span class="music-text">Nh·∫°c</span>';
            musicPlaying = false;
            musicToggle.style.background = 'linear-gradient(45deg, #6a8caf, #8aa8c9)';
        } else {
            backgroundMusic.play().then(() => {
                musicToggle.innerHTML = '<i class="fas fa-volume-up"></i><span class="music-text">T·∫Øt nh·∫°c</span>';
                musicPlaying = true;
                musicToggle.style.background = 'linear-gradient(45deg, #8a6bc9, #a08bd4)';
            }).catch(e => {
                console.log("Audio play failed:", e);
                alert('Vui l√≤ng cho ph√©p ph√°t nh·∫°c tr√™n trang web n√†y.');
            });
        }
    });
    
    // Try to auto-play music on first interaction
    document.addEventListener('click', function initMusic() {
        if (!userInteracted) {
            backgroundMusic.volume = 0.3;
            userInteracted = true;
        }
    });
    
    // Add CSS animation for fadeIn
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
    
    // Create floating particles
    function createParticles() {
        const container = document.querySelector('.background-animation');
        
        for (let i = 0; i < 8; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');
            
            // Random properties
            const size = Math.random() * 60 + 40;
            const posX = Math.random() * 100;
            const posY = Math.random() * 100;
            const delay = Math.random() * 20;
            const duration = Math.random() * 20 + 20;
            
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${posX}%`;
            particle.style.top = `${posY}%`;
            particle.style.animationDelay = `${delay}s`;
            particle.style.animationDuration = `${duration}s`;
            
            container.appendChild(particle);
        }
    }
    
    // Create confetti effect
    function createConfetti() {
        const confettiContainer = document.createElement('div');
        confettiContainer.style.position = 'fixed';
        confettiContainer.style.top = '0';
        confettiContainer.style.left = '0';
        confettiContainer.style.width = '100%';
        confettiContainer.style.height = '100%';
        confettiContainer.style.pointerEvents = 'none';
        confettiContainer.style.zIndex = '9999';
        document.body.appendChild(confettiContainer);
        
        const colors = ['#8a6bc9', '#6a8caf', '#4a6fa5', '#a08bd4', '#8aa8c9'];
        
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.style.position = 'absolute';
            confetti.style.width = '10px';
            confetti.style.height = '10px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.borderRadius = '50%';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.top = '-20px';
            confetti.style.opacity = '0.8';
            
            confettiContainer.appendChild(confetti);
            
            // Animation
            const animation = confetti.animate([
                { 
                    transform: `translateY(0) rotate(0deg)`, 
                    opacity: 1 
                },
                { 
                    transform: `translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 360}deg)`, 
                    opacity: 0 
                }
            ], {
                duration: Math.random() * 3000 + 2000,
                easing: 'cubic-bezier(0.215, 0.610, 0.355, 1)'
            });
            
            animation.onfinish = () => {
                confetti.remove();
                if (confettiContainer.children.length === 0) {
                    confettiContainer.remove();
                }
            };
        }
    }
    
    // Loading functions
    function showLoading() {
        let loadingEl = document.querySelector('.loading');
        if (!loadingEl) {
            loadingEl = document.createElement('div');
            loadingEl.className = 'loading';
            loadingEl.innerHTML = `
                <div class="loading-spinner"></div>
                <p style="color: #4a6fa5; font-size: 18px;">ƒêang g·ª≠i ph·∫£n h·ªìi...</p>
            `;
            document.body.appendChild(loadingEl);
        }
        loadingEl.style.display = 'flex';
    }
    
    function hideLoading() {
        const loadingEl = document.querySelector('.loading');
        if (loadingEl) {
            loadingEl.style.display = 'none';
        }
    }
    
    // Save to Google Sheets function
    function saveToGoogleSheets(data) {
        // FOR NOW: Log data and save to localStorage
        console.log('RSVP Data:', data);
        console.log('\n=== H∆Ø·ªöNG D·∫™N K·∫æT N·ªêI GOOGLE SHEETS ===');
        console.log('1. T·∫°o Google Apps Script t·∫°i: script.google.com');
        console.log('2. D√°n code x·ª≠ l√Ω form (t√¥i s·∫Ω cung c·∫•p)');
        console.log('3. Deploy as Web App');
        console.log('4. Thay th·∫ø URL trong code');
        console.log('5. Form s·∫Ω t·ª± ƒë·ªông g·ª≠i d·ªØ li·ªáu ƒë·∫øn Google Sheets');
        
        // Save to localStorage as backup
        try {
            let responses = JSON.parse(localStorage.getItem('wedding_rsvp')) || [];
            responses.push(data);
            localStorage.setItem('wedding_rsvp', JSON.stringify(responses));
            console.log('ƒê√£ l∆∞u v√†o localStorage l√†m backup');
        } catch (e) {
            console.log('Kh√¥ng th·ªÉ l∆∞u v√†o localStorage');
        }
        
        // Google Apps Script integration code (uncomment and add your URL)
        /*
        const scriptURL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
        
        fetch(scriptURL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(() => console.log('Success!'))
        .catch(error => console.error('Error:', error));
        */
    }
    
    // Initialize particles
    createParticles();
    
    // Add hover effects to decorative elements
    const decorDots = document.querySelectorAll('.decor-dot');
    decorDots.forEach(dot => {
        dot.addEventListener('mouseenter', () => {
            dot.style.transform = 'scale(1.5)';
            dot.style.transition = 'transform 0.3s ease';
        });
        
        dot.addEventListener('mouseleave', () => {
            dot.style.transform = 'scale(1)';
        });
    });
    
    // Add flower animation on hover
    const flowers = document.querySelectorAll('.flower-icon');
    flowers.forEach(flower => {
        flower.addEventListener('mouseenter', () => {
            flower.style.color = '#8a6bc9';
            flower.style.transform = 'scale(1.3)';
            flower.style.transition = 'all 0.3s ease';
        });
        
        flower.addEventListener('mouseleave', () => {
            flower.style.color = '';
            flower.style.transform = '';
        });
    });
    
    console.log('‚ú® Thi·ªáp m·ªùi c∆∞·ªõi H√† My & Trung ƒê·ª©c ƒë√£ s·∫µn s√†ng!');
    console.log('üë§ T√™n kh√°ch: ' + (guestName || 'Qu√Ω kh√°ch (ch∆∞a c√≥ t√™n)'));
    console.log('üîó URL: ' + window.location.href);
    console.log('üéµ Nh·∫°c: Click n√∫t nh·∫°c ƒë·ªÉ b·∫≠t');
});
